Sub Exploitation()

    UserForm1.Show

End Sub

Sub Programme_a_ne_pas_lancer()
Dim LastRw As Long
Dim nomserie As String

Dim Cht As ChartObject
Dim sel As Range

'Uniformise chaque classeur
Application.ScreenUpdating = False
ActiveSheet.Name = "Donnée Brut"
Application.Calculation = xlAutomatic

nserie = UserForm1.SpinNb.Value

'Supprime les lignes inutiles au début
Cells.Find(What:="number", After:=ActiveCell, LookIn:=xlFormulas, LookAt:= _
        xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=False _
        , SearchFormat:=False).Activate
    Range(Selection, Selection.End(xlUp)).Select
    Selection.EntireRow.Delete

'Converti le format CSV
Columns("A:A").Select
Selection.TextToColumns Destination:=Range("A1"), DataType:=xlDelimited, _
TextQualifier:=xlDoubleQuote, ConsecutiveDelimiter:=False, Tab:=True, _
Semicolon:=False, Comma:=True, Space:=False, Other:=False, FieldInfo _
:=Array(1, 1), TrailingMinusNumbers:=False

'La difference entre certaine graphtec se traduit par une autre colonne avec des msec. Pour uniformiser le tout nous supprimons cette colonne
For i = 1 To i = 30
If Cells(1, i).Value = "ms" Then
Columns(i).Select
Selection.Delete
End If
Next i
    
'Passe toutes les valeurs en valeurs absolue
Cells.Replace What:="+", Replacement:=""
Cells.Replace What:="-", Replacement:=""

'Supprime la colonne C si elle est vide
If Cells(1, 3).Value = "0" Then
 Columns("C:C").Select
    Selection.Delete Shift:=xlToLeft
End If

'insert 9 colonne pour pouvoir calculer les temps
For n = 1 To 9
Range("C:C").Insert
Next n

'insert une ligne au début
Rows("1:1").Select
    Selection.Insert Shift:=xlDown, CopyOrigin:=xlFormatFromLeftOrAbove

'Calcul les temps en prenant compte des changement de jour et de mois
Columns("C:K").Select
Selection.NumberFormat = "0.00"
Range("C2").Value = "Heure"
Range("C3").FormulaLocal = "=Heure(B3)"
Range("D2").Value = "Minute"
Range("D3").FormulaLocal = "=Minute(B3)"
Range("E2").Value = "Seconde"
Range("E3").FormulaLocal = "=Seconde(B3)"
Range("F2").Value = "Jour"
Range("F3").FormulaLocal = "=Jour(B3)"
Range("F4").FormulaLocal = "=Jour(B4)"
Range("G2").Value = "Différence de jour"
Range("G3").FormulaLocal = "=F4-F3"
Range("H2").Value = "Différence de jour mois"
Range("H3").FormulaLocal = "=G3/G3"
Range("I1").Value = "Différence de 24h"
Range("I2").Value = "=0"
Range("I3").FormulaLocal = "=24*H3"
Range("J2").Value = "Date en Heure"
Range("J3").FormulaLocal = "=C3+D3/60+E3/3600"

'Etire toute les formules vers le bas
LastRw = Cells(Rows.Count, 1).End(xlUp).Row
Range("C3:C" & LastRw).FillDown
Range("D3:D" & LastRw).FillDown
Range("E3:E" & LastRw).FillDown
Range("F3:F" & LastRw).FillDown
Range("G3:G" & LastRw).FillDown
Range("H3:H" & LastRw).FillDown
Range("I3:I" & LastRw).FillDown
Range("J3:J" & LastRw).FillDown
Columns("C:K").Select
Selection.NumberFormat = "0.00"

'Recherche une erreur (Division par) du à la différence de jour
For i = 3 To LastRw
    If IsError(Cells(i, 9)) Then
    Cells(i, 9).Value = 0
    End If
    If IsError(Cells(i, 10)) Then
    Cells(i, 10).Value = 0
    End If
    If IsError(Cells(i, 8)) Then
    Cells(i, 8).Value = 0
    End If
Next i

'Calcul le temps absolue en heure
Range("K2").Value = "Temps en Heure"
Range("K3").Value = "=0"
Range("K4").FormulaLocal = "=J4-J3+K3+I3"
Range("K4:K" & LastRw).FillDown

'Définie le chemin que l'on prend si l'option T° est activé
Dim optiont As Byte
optiont = 12
Dim sortieboucle As Byte
sortieboucle = 0

'Detect si il y a une différence de tension suppérieur à 30mV entre deux point de mesure. Ce qui signifie le début d'une décharge.
If UserForm1.Checkdech.Value = True Then
Dim detectionDech As Long
    For i = 3 To LastRw
        If Cells(i, optiont + 1) - Cells(i + 1, optiont + 1) > 0.03 Then
        detectionDech = i
        sortieboucle = 1
        End If
    If sortieboucle = 1 Then
    i = LastRw
    End If
    Next i
End If

'possibilité de gérer une correction en T°
Dim Tessai As Long
Dim delta As Single
Dim Tref As Long
Dim tempscor As Single
If UserForm1.OptionCorec.Value = True Then
    optiont = 12
    Tessai = UserForm1.T°txt.Value
    Tref = UserForm1.Treftxt.Value
        If UserForm1.OptionSup3.Value = True Then
          delta = 0.006
        Else
            delta = 0.01
        End If
    Columns(12).Insert
    Cells(2, 12).Value = "Correction en température"
        For i = 3 To LastRw
            tempscor = (Cells(i, 11)) / (1 + (delta * (Tessai - Tref)))
            Cells(i, 12) = tempscor
        Next i
Else
    optiont = 11
End If

Application.ScreenUpdating = True

If Cells(2, optiont + 1).Value = "ms" Then
    Columns(optiont + 1).EntireColumn.Delete
End If

UserForm1.Hide

'Permet en fonction de l'option choisi de nommer ou non automatiquement les séries
If UserForm1.OptionSerie.Value = True Then
For i = 1 To nserie
nomserie = "série" + Str(i)
Cells(1, optiont + i).Value = nomserie
ActiveWindow.ScrollColumn = 4 + i
Next i
Else
For i = 1 To nserie
nomserie = InputBox("Nom de la série")
Cells(1, optiont + i).Value = nomserie
ActiveWindow.ScrollColumn = 4 + i
Next i
End If

Application.ScreenUpdating = False

'Masque les colonnes du calcul de date
Range("C:J").EntireColumn.Hidden = True

'ajoute un Graphique et le clean
ActiveSheet.Shapes.AddChart.Select
ActiveChart.ChartType = xlXYScatterSmooth
Set graphActu = ActiveChart
graphActu.SeriesCollection(1).Delete
    
'met en forme les colonnes avec les couleurs correspondante et ajoute toutes les séries sur le graph
For i = 1 To nserie
ActiveSheet.Range(Cells(3, optiont + i), Cells(LastRw, optiont + i)).Select
Range(Cells(3, optiont + i), Cells(LastRw, optiont + i)).Interior.ColorIndex = 36 + i
graphActu.SeriesCollection.NewSeries
graphActu.SeriesCollection(i).Name = Cells(1, optiont + i)
graphActu.SeriesCollection(i).XValues = Range(Cells(3, optiont), Cells(LastRw, optiont))
graphActu.SeriesCollection(i).Values = Selection
 graphActu.SeriesCollection(i).Border.ColorIndex = 36 + i
   graphActu.SeriesCollection(i).MarkerBackgroundColorIndex = 36 + i
   graphActu.SeriesCollection(i).MarkerForegroundColorIndex = 36 + i
Next i

'Réduit la taille des points de chaque série
For i = 1 To nserie
graphActu.SeriesCollection(i).Select
    With Selection
        .MarkerSize = 2
    End With
Next i

'Detect si des valeurs sont supérieur à 10 ce qui en général se traduit par une série de T° ou d'intensité
For i = 1 To nserie
ActiveSheet.Range(Cells(3, optiont + i), Cells(LastRw, optiont + i)).Select
maxi = Application.WorksheetFunction.Max(Selection)
'Si les conditions validé alors les séries concernés se référe à un second axe
If maxi > 10 Then
    graphActu.SeriesCollection(i).Select
    With Selection
        .AxisGroup = 2
End With
 ActiveChart.SetElement (msoElementSecondaryValueAxisTitleRotated)
    ActiveChart.Axes(xlValue, xlSecondary).AxisTitle.Text = "Température (°C)"
    Selection.Format.TextFrame2.TextRange.Characters.Text = "Température (°C)"
    With Selection.Format.TextFrame2.TextRange.Characters(1, 16).ParagraphFormat
        .TextDirection = msoTextDirectionLeftToRight
        .Alignment = msoAlignCenter
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(1, 16).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With
End If
Next i

'Copie colle le graph dans une nouvelle feuille
For Each Cht In ActiveSheet.ChartObjects
    Cht.Cut
    Sheets.add(After:=Worksheets("Donnée Brut")).Name = "Graph"
    Sheets("Graph").Paste
'agrandi le graph
With Sheets("Graph").ChartObjects(1)
        .Left = Range("A1:P40").Left
        .Top = Range("A1:P40").Top
        .Width = Range("A1:P40").Width
        .Height = Range("A1:P40").Height
End With
Next Cht

'Renome l'axe vertical principal "Tension (V)"
ActiveChart.SetElement (msoElementPrimaryValueAxisTitleRotated)
    Selection.Format.TextFrame2.TextRange.Characters.Text = "Tension (V)"
    With Selection.Format.TextFrame2.TextRange.Characters(1, 11).ParagraphFormat
        .TextDirection = msoTextDirectionLeftToRight
        .Alignment = msoAlignCenter
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(1, 7).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(8, 4).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With

'Renome l'axe horizontal "Temps (h)"
 ActiveChart.SetElement (msoElementPrimaryCategoryAxisTitleAdjacentToAxis)
    Selection.Format.TextFrame2.TextRange.Characters.Text = "Temps (h)"
    With Selection.Format.TextFrame2.TextRange.Characters(1, 9).ParagraphFormat
        .TextDirection = msoTextDirectionLeftToRight
        .Alignment = msoAlignCenter
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(1, 9).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With

'Si l'option décharge est activé et la tension d'arrêt rempli, alors on règle l'échelle principal du grpahique
If UserForm1.Checkdech.Value = True Then
ActiveSheet.ChartObjects("Graphique 1").Activate
    ActiveChart.Axes(xlValue).Select
    ActiveChart.Axes(xlValue).MaximumScale = 2.5
    ActiveChart.Axes(xlValue).MinimumScale = UserForm1.TextU.Value
    ActiveChart.SetElement (msoElementChartTitleAboveChart)
End If

ActiveChart.SetElement (msoElementChartTitleAboveChart)
ActiveChart.ChartTitle.Text = UserForm1.TextNom.Value

'Si l'option modèle est activé, alors création d'un graph intensité
If UserForm1.OptionMod.Value = True Then
    Dim Ush As Range
    Worksheets("Donnée Brut").Activate

For i = 1 To 35
    If Cells(2, i) = "mV" Then
        Range(Cells(3, i), Cells(LastRw, i)).Select
        Set Ush = Selection
    End If
Next i

Worksheets("Donnée Brut").Activate
ActiveSheet.Shapes.AddChart.Select
ActiveChart.ChartType = xlXYScatterSmooth

Set graphActu = ActiveChart

graphActu.SeriesCollection(1).Name = "Image de l'intensité"

Dim Cht1 As ChartObject

For Each Cht1 In ActiveSheet.ChartObjects
    Cht1.Cut
    Sheets("Graph").Paste

With Sheets("Graph").ChartObjects(2)
        .Left = Range("A40:P80").Left
        .Top = Range("A40:P80").Top
        .Width = Range("A40:P80").Width
        .Height = Range("A40:P80").Height
End With
Next Cht1
Worksheets("Graph").Activate
Set graphActu = ActiveChart
ActiveChart.SetElement (msoElementPrimaryValueAxisTitleRotated)
    Selection.Format.TextFrame2.TextRange.Characters.Text = "Tension (mV)"
    With Selection.Format.TextFrame2.TextRange.Characters(1, 11).ParagraphFormat
        .TextDirection = msoTextDirectionLeftToRight
        .Alignment = msoAlignCenter
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(1, 7).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(8, 4).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With
    
 ActiveChart.SetElement (msoElementPrimaryCategoryAxisTitleAdjacentToAxis)
    Selection.Format.TextFrame2.TextRange.Characters.Text = "Temps (h)"
    With Selection.Format.TextFrame2.TextRange.Characters(1, 9).ParagraphFormat
        .TextDirection = msoTextDirectionLeftToRight
        .Alignment = msoAlignCenter
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(1, 9).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With

Dim T° As Range

Worksheets("Donnée Brut").Activate

For i = 1 To 35
If Cells(2, i) = "degC" Then

Range(Cells(3, i), Cells(LastRw, i)).Select
Set T° = Selection

End If

Next i

Worksheets("Donnée Brut").Activate
ActiveSheet.Shapes.AddChart.Select
ActiveChart.ChartType = xlXYScatterSmooth

Set graphActu = ActiveChart
graphActu.SeriesCollection(1).Name = "Température durant l'essai"
Dim Cht13 As ChartObject

For Each Cht13 In ActiveSheet.ChartObjects
    Cht13.Cut
    Sheets("Graph").Paste
With Sheets("Graph").ChartObjects(3)
        .Left = Range("L40:P80").Left
        .Top = Range("L40:P80").Top
        .Width = Range("L40:P80").Width
        .Height = Range("L40:P80").Height
End With
Next Cht13

Worksheets("Graph").Activate
Set graphActu = ActiveChart
ActiveChart.SetElement (msoElementPrimaryValueAxisTitleRotated)
    Selection.Format.TextFrame2.TextRange.Characters.Text = "Tension (V)"
    With Selection.Format.TextFrame2.TextRange.Characters(1, 11).ParagraphFormat
        .TextDirection = msoTextDirectionLeftToRight
        .Alignment = msoAlignCenter
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(1, 7).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(8, 4).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With
    
 ActiveChart.SetElement (msoElementPrimaryCategoryAxisTitleAdjacentToAxis)
    Selection.Format.TextFrame2.TextRange.Characters.Text = "Temps (h)"
    With Selection.Format.TextFrame2.TextRange.Characters(1, 9).ParagraphFormat
        .TextDirection = msoTextDirectionLeftToRight
        .Alignment = msoAlignCenter
    End With
    With Selection.Format.TextFrame2.TextRange.Characters(1, 9).Font
        .BaselineOffset = 0
        .Bold = msoTrue
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.RGB = RGB(0, 0, 0)
        .Fill.Transparency = 0
        .Fill.Solid
        .Size = 10
        .Italic = msoFalse
        .Kerning = 12
        .Name = "+mn-lt"
        .UnderlineStyle = msoNoUnderline
        .Strike = msoNoStrike
    End With

Worksheets("Graph").Activate
ActiveSheet.ChartObjects("Graphique 3").Activate
    ActiveSheet.Shapes("Graphique 3").Height = 161.5748031496
    ActiveSheet.Shapes("Graphique 3").Width = 555.5905511811
    ActiveChart.Parent.Copy
    Sheets("Essai labo R&D").Select
    Range("B81").Select
    ActiveSheet.Pictures.Paste.Select

Worksheets("Graph").Activate
ActiveSheet.ChartObjects("Graphique 2").Activate
    ActiveSheet.Shapes("Graphique 2").Height = 161.5748031496
    ActiveSheet.Shapes("Graphique 2").Width = 555.5905511811
    ActiveChart.Parent.Copy
    Sheets("Essai labo R&D").Select
    Range("B93").Select
    ActiveSheet.Pictures.Paste.Select
    
Worksheets("Graph").Activate
 ActiveSheet.ChartObjects("Graphique 1").Activate
    ActiveSheet.Shapes("Graphique 1").Height = 286.2992125984
    ActiveSheet.Shapes("Graphique 1").Width = 555.5905511811
    ActiveChart.Parent.Copy
    Sheets("Essai labo R&D").Select
    Range("B61").Select
    ActiveSheet.Pictures.Paste.Select

Application.ScreenUpdating = True
End If

'Si l'option calcul de capa est activé alors calcul à I constant
If UserForm1.CheckCalCap.Value = True Then
    Worksheets("Donnée Brut").Activate
    Columns(nserie + optiont + 1).Insert
    Dim col As Byte
    Dim inten As Single
    inten = UserForm1.TextI.Value
    col = nserie + optiont + 1
    Cells(2, col).Value = "Capacité corigé (Ifixe)"
        For i = detectionDech To LastRw
            Cells(i, col).Value = (((Cells(i, optiont).Value) - (Cells(i - 1, optiont).Value)) * inten) + Cells(i - 1, col).Value
        Next i
End If

If UserForm1.CommandChris.Value = True Then
    If UserForm1.Checkdech.Value = True Then
        Dim Ustop As Single
        Ustop = UserForm1.TextU.Value
        Worksheets("Essai labo R&D").Activate
        Cells(18, 4).Value = Ustop
    End If
    
End If

End Sub
